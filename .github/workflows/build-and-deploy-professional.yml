name: Professional CI/CD - Build & Deploy to EB

on:
  push:
    branches: [main]
    paths:
      - 'coral-server/**'
      - 'agents/**'
      - 'docker-compose.yml'
      - '.ebextensions/**'
      - '.github/workflows/build-and-deploy-professional.yml'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker build (use existing images)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  CORAL_SERVER_REPO: coral-server
  AGENT_REPO: pardon-agent

jobs:
  build-and-push:
    name: Build Docker Images & Push to ECR
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_build }}
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üè∑Ô∏è Generate image metadata
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "tags=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Image tag: ${SHORT_SHA}"
      
      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: üîë Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: üèóÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: üê≥ Build and push Coral Server
        uses: docker/build-push-action@v4
        with:
          context: ./coral-server
          file: ./coral-server/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.CORAL_SERVER_REPO }}:${{ steps.meta.outputs.tags }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.CORAL_SERVER_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ü§ñ Build and push Pardon Agent
        uses: docker/build-push-action@v4
        with:
          context: ./agents
          file: ./agents/Dockerfile.agent
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.AGENT_REPO }}:${{ steps.meta.outputs.tags }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.AGENT_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ‚úÖ Build complete
        run: |
          echo "üéâ Images built and pushed successfully!"
          echo "Coral Server: ${{ steps.login-ecr.outputs.registry }}/${{ env.CORAL_SERVER_REPO }}:${{ steps.meta.outputs.tags }}"
          echo "Pardon Agent: ${{ steps.login-ecr.outputs.registry }}/${{ env.AGENT_REPO }}:${{ steps.meta.outputs.tags }}"

  deploy:
    name: Deploy to Elastic Beanstalk
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: ${{ always() && (needs.build-and-push.result == 'success' || inputs.skip_build) }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: üîë Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: üîÑ Update docker-compose.yml for ECR images
        run: |
          echo "üìù Updating docker-compose.yml to use ECR images..."
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          
          # Create backup
          cp docker-compose.yml docker-compose.yml.backup
          
          # Replace coral-server build with image
          sed -i '/coral-server:/,/container_name: coral-server/ {
            /build:/,/dockerfile: Dockerfile/d
            /container_name: coral-server/i\    image: '"${ECR_REGISTRY}"'/${{ env.CORAL_SERVER_REPO }}:latest
          }' docker-compose.yml
          
          # Replace agent builds with images (for all 7 agents)
          for agent in cz sbf trump-donald trump-melania trump-eric trump-donjr trump-barron; do
            sed -i "/agent-${agent}:/,/container_name: agent-${agent}/ {
              /build:/,/dockerfile: Dockerfile.agent/d
              /container_name: agent-${agent}/i\    image: '"${ECR_REGISTRY}"'/${{ env.AGENT_REPO }}:latest
            }" docker-compose.yml
          done
          
          echo "‚úÖ docker-compose.yml updated"
          echo "üìÑ Changes:"
          diff docker-compose.yml.backup docker-compose.yml || true
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: üì¶ Install EB CLI
        run: |
          pip install --upgrade pip
          pip install awsebcli
      
      - name: üöÄ Deploy to Elastic Beanstalk
        run: |
          echo "=========================================="
          echo "üöÄ Deploying to Elastic Beanstalk"
          echo "Environment: pardon-production"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "=========================================="
          
          # Check current status
          eb status pardon-production || echo "‚ö†Ô∏è Environment status check failed"
          
          # Deploy with updated configuration
          eb deploy pardon-production --timeout 20 --staged
          
          echo ""
          echo "‚úÖ Deployment command completed!"
      
      - name: ‚è≥ Wait for deployment to stabilize
        run: |
          echo "‚è≥ Waiting for deployment to complete and become healthy..."
          echo "This may take 5-10 minutes..."
          
          MAX_ATTEMPTS=40
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo ""
            echo "üîç Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Get environment health
            HEALTH=$(eb health pardon-production --view-request 2>&1 || echo "Error")
            
            # Check if deployment is healthy
            if echo "$HEALTH" | grep -q "Ok\|Green"; then
              echo "‚úÖ Deployment is HEALTHY!"
              exit 0
            elif echo "$HEALTH" | grep -q "Severe\|Red"; then
              echo "‚ö†Ô∏è Environment is unhealthy (attempt $ATTEMPT/$MAX_ATTEMPTS)"
              echo "$HEALTH"
            else
              echo "üìä Status: $HEALTH"
            fi
            
            # Wait before next check
            sleep 15
          done
          
          echo "‚è∞ Deployment timeout reached"
          echo "üìä Final status:"
          eb health pardon-production --view-request || true
          exit 1
      
      - name: üß™ Smoke test
        run: |
          echo "üß™ Running smoke tests..."
          
          # Get the CNAME
          CNAME=$(eb status pardon-production | grep CNAME | awk '{print $2}')
          echo "üåê Testing URL: http://${CNAME}:5555/health"
          
          # Test health endpoint
          for i in {1..5}; do
            echo "Attempt $i/5..."
            if curl -f --max-time 10 "http://${CNAME}:5555/health"; then
              echo ""
              echo "‚úÖ Health check PASSED!"
              exit 0
            fi
            echo "‚ö†Ô∏è Health check failed, retrying..."
            sleep 5
          done
          
          echo "‚ùå Smoke test failed after 5 attempts"
          echo "Note: Service may still be starting up. Check manually:"
          echo "  curl http://${CNAME}:5555/health"
      
      - name: üìä Deployment summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä DEPLOYMENT SUMMARY"
          echo "=========================================="
          echo ""
          echo "üîó Environment Details:"
          eb status pardon-production || true
          echo ""
          echo "üè• Health Status:"
          eb health pardon-production --view-request || true
          echo ""
          echo "üåê Your Coral Server URL:"
          CNAME=$(eb status pardon-production | grep CNAME | awk '{print $2}')
          echo "  http://${CNAME}:5555"
          echo ""
          echo "üìù Next Steps:"
          echo "  1. Verify: curl http://${CNAME}:5555/health"
          echo "  2. Update Vercel env: CORAL_SERVER_URL=http://${CNAME}:5555"
          echo "  3. Test from Next.js backend"
          echo ""
      
      - name: ‚ùå On failure - show logs
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Fetching logs..."
          echo ""
          eb logs pardon-production --all || true
          echo ""
          echo "üîç Troubleshooting:"
          echo "  1. Check logs: eb logs pardon-production"
          echo "  2. SSH to instance: eb ssh pardon-production"
          echo "  3. Check containers: docker-compose ps"
          echo "  4. View container logs: docker-compose logs"

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]
    if: always()
    
    steps:
      - name: üì¢ Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "üéâ ‚úÖ DEPLOYMENT SUCCESSFUL!"
            echo "Your Coral Server is now running!"
          else
            echo "‚ùå DEPLOYMENT FAILED"
            echo "Check the logs above for details"
            exit 1
          fi

