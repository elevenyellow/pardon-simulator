name: Update Configs in S3

on:
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent name (or "all" for all agents)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - cz
          - sbf
          - trump-donald
          - trump-melania
          - trump-eric
          - trump-donjr
          - trump-barron
      restart_agent:
        description: 'Restart agent after update?'
        required: true
        default: true
        type: boolean

jobs:
  upload-configs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload configs to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          chmod +x scripts/upload-configs.sh
          
          if [ "${{ github.event.inputs.agent }}" = "all" ]; then
            echo "üì§ Uploading configs for all agents..."
            ./scripts/upload-configs.sh
          else
            echo "üì§ Uploading configs for ${{ github.event.inputs.agent }}..."
            AGENT="${{ github.event.inputs.agent }}"
            FILES=("operational-private.txt" "personality-public.txt" "scoring-config.txt" "tool-descriptions.txt")
            
            for file in "${FILES[@]}"; do
              filepath="agents/${AGENT}/${file}"
              
              if [ -f "$filepath" ]; then
                aws s3 cp "${filepath}" \
                  "s3://${S3_BUCKET_NAME}/agents/${AGENT}/${file}" \
                  --region ${{ secrets.AWS_REGION }} \
                  --sse AES256
                echo "‚úì Uploaded ${file}"
              fi
            done
          fi
      
      - name: Restart agent on EB
        if: ${{ github.event.inputs.restart_agent == 'true' && github.event.inputs.agent != 'all' }}
        run: |
          # Install EB CLI
          pip install awsebcli
          
          # Restart specific agent
          eb ssh --command "cd /var/app/current && docker-compose restart agent-${{ github.event.inputs.agent }}"
          
          echo "‚úÖ Agent restarted!"
      
      - name: Notify completion
        run: |
          echo "=========================================="
          echo "‚úÖ Configs uploaded to S3!"
          echo "=========================================="
          
          if [ "${{ github.event.inputs.restart_agent }}" = "true" ]; then
            if [ "${{ github.event.inputs.agent }}" = "all" ]; then
              echo "‚ö†Ô∏è  To apply changes, restart all agents:"
              echo "   eb ssh --command 'cd /var/app/current && docker-compose restart'"
            else
              echo "‚úÖ Agent ${{ github.event.inputs.agent }} restarted"
            fi
          else
            echo "‚ö†Ô∏è  Agent not restarted. Changes will apply on next restart."
          fi

