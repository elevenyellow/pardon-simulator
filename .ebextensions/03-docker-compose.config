commands:
  01_install_docker_compose:
    command: |
      # Install Docker Compose
      curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose
    test: "[ ! -f /usr/local/bin/docker-compose ]"

container_commands:
  01_docker_compose_up:
    command: |
      # Create .env file from environment variables
      cd /var/app/current
      
      cat > .env.production << EOF
      BACKEND_URL=${BACKEND_URL}
      MODEL_API_KEY=${MODEL_API_KEY}
      MODEL_NAME=${MODEL_NAME}
      SOLANA_RPC_URL=${SOLANA_RPC_URL}
      SOLANA_PRIVATE_KEY_CZ=${SOLANA_PRIVATE_KEY_CZ}
      SOLANA_PRIVATE_KEY_SBF=${SOLANA_PRIVATE_KEY_SBF}
      SOLANA_PRIVATE_KEY_DONALD=${SOLANA_PRIVATE_KEY_DONALD}
      SOLANA_PRIVATE_KEY_MELANIA=${SOLANA_PRIVATE_KEY_MELANIA}
      SOLANA_PRIVATE_KEY_ERIC=${SOLANA_PRIVATE_KEY_ERIC}
      SOLANA_PRIVATE_KEY_DONJR=${SOLANA_PRIVATE_KEY_DONJR}
      SOLANA_PRIVATE_KEY_BARRON=${SOLANA_PRIVATE_KEY_BARRON}
      AWS_REGION=${AWS_REGION}
      S3_BUCKET_NAME=${S3_BUCKET_NAME}
      EOF
      
      # Start services with Docker Compose
      /usr/local/bin/docker-compose --env-file .env.production up -d
    leader_only: true

  02_cleanup_old_containers:
    command: |
      # Remove old containers and images
      docker system prune -af --filter "until=72h" || true
    leader_only: true

