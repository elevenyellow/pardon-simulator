version: '3.8'

# ==============================================================================
# YAML Anchors - Reusable configuration templates
# ==============================================================================

x-agent-common: &agent-common
  image: ${ECR_REGISTRY:-${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com}/pardon-agent:latest
  restart: unless-stopped
  networks:
    - pardon-network
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  depends_on:
    coral-server:
      condition: service_healthy

x-agent-env-common: &agent-env-common
  CORAL_SSE_URL: http://coral-server:5555/sse
  BACKEND_URL: ${BACKEND_URL}
  MODEL_API_KEY: ${MODEL_API_KEY}
  MODEL_NAME: ${MODEL_NAME:-gpt-5.1}
  SOLANA_RPC_URL: ${SOLANA_RPC_URL}
  AWS_REGION: ${AWS_REGION:-us-east-1}
  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
  S3_BUCKET_NAME: ${S3_BUCKET_NAME:-pardon-simulator-configs}

# ==============================================================================
# Services
# ==============================================================================

services:
  # Coral Server - Multi-agent orchestration
  coral-server:
    image: ${ECR_REGISTRY:-${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com}/coral-server:latest
    container_name: coral-server
    ports:
      - "5555:5555"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5555/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - pardon-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # AI Agents - Using YAML anchors to eliminate duplication
  agent-cz:
    <<: *agent-common
    container_name: agent-cz
    working_dir: /app/cz
    command: ["/app/fetch-and-start.sh", "cz"]
    environment:
      <<: *agent-env-common
      AGENT_NAME: cz
      CORAL_AGENT_ID: cz
      SOLANA_PRIVATE_KEY: ${SOLANA_PRIVATE_KEY_CZ}

  agent-sbf:
    <<: *agent-common
    container_name: agent-sbf
    working_dir: /app/sbf
    command: ["/app/fetch-and-start.sh", "sbf"]
    environment:
      <<: *agent-env-common
      AGENT_NAME: sbf
      CORAL_AGENT_ID: sbf
      SOLANA_PRIVATE_KEY: ${SOLANA_PRIVATE_KEY_SBF}

  agent-trump-donald:
    <<: *agent-common
    container_name: agent-trump-donald
    working_dir: /app/trump-donald
    command: ["/app/fetch-and-start.sh", "trump-donald"]
    environment:
      <<: *agent-env-common
      AGENT_NAME: trump-donald
      CORAL_AGENT_ID: trump-donald
      SOLANA_PRIVATE_KEY: ${SOLANA_PRIVATE_KEY_DONALD}

  agent-trump-melania:
    <<: *agent-common
    container_name: agent-trump-melania
    working_dir: /app/trump-melania
    command: ["/app/fetch-and-start.sh", "trump-melania"]
    environment:
      <<: *agent-env-common
      AGENT_NAME: trump-melania
      CORAL_AGENT_ID: trump-melania
      SOLANA_PRIVATE_KEY: ${SOLANA_PRIVATE_KEY_MELANIA}

  agent-trump-eric:
    <<: *agent-common
    container_name: agent-trump-eric
    working_dir: /app/trump-eric
    command: ["/app/fetch-and-start.sh", "trump-eric"]
    environment:
      <<: *agent-env-common
      AGENT_NAME: trump-eric
      CORAL_AGENT_ID: trump-eric
      SOLANA_PRIVATE_KEY: ${SOLANA_PRIVATE_KEY_ERIC}

  agent-trump-donjr:
    <<: *agent-common
    container_name: agent-trump-donjr
    working_dir: /app/trump-donjr
    command: ["/app/fetch-and-start.sh", "trump-donjr"]
    environment:
      <<: *agent-env-common
      AGENT_NAME: trump-donjr
      CORAL_AGENT_ID: trump-donjr
      SOLANA_PRIVATE_KEY: ${SOLANA_PRIVATE_KEY_DONJR}

  agent-trump-barron:
    <<: *agent-common
    container_name: agent-trump-barron
    working_dir: /app/trump-barron
    command: ["/app/fetch-and-start.sh", "trump-barron"]
    environment:
      <<: *agent-env-common
      AGENT_NAME: trump-barron
      CORAL_AGENT_ID: trump-barron
      SOLANA_PRIVATE_KEY: ${SOLANA_PRIVATE_KEY_BARRON}

networks:
  pardon-network:
    driver: bridge
