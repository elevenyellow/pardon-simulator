// Pardon Simulator - Database Schema
// PostgreSQL database for game state, scoring, and leaderboards

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String    @id @default(cuid())
  walletAddress   String    @unique
  username        String    // Auto-generated from wallet
  totalScore      Float     @default(0)
  createdAt       DateTime  @default(now())
  lastActiveAt    DateTime? // Track last activity for admin panel
  
  sessions        Session[]
  scores          Score[]
  leaderboardEntries LeaderboardEntry[]
  
  @@index([walletAddress])
  @@index([createdAt])
  @@index([lastActiveAt])
}

model Session {
  id              String    @id @default(cuid())
  userId          String
  coralSessionId  String    // Coral Server session ID
  currentScore    Float     @default(0)
  startTime       DateTime  @default(now())
  endTime         DateTime?
  weekId          String    // Format: "2024-W45"
  messageCount    Int       @default(0)
  lastActivityAt  DateTime  @default(now())
  walletAddress   String?   // Denormalized for faster queries
  walletVerified    Boolean   @default(false)
  walletVerifiedAt  DateTime?
  walletSignature   String?   // Store signature for audit trail
  
  user            User      @relation(fields: [userId], references: [id])
  threads         Thread[]
  scores          Score[]
  
  @@unique([userId, weekId])  // âœ… Prevent duplicate sessions for same user+week
  @@index([coralSessionId])
  @@index([startTime])
  @@index([lastActivityAt])
  @@index([walletAddress])
}

model Thread {
  id              String    @id @default(cuid())
  sessionId       String
  coralThreadId   String    // Coral Server thread ID
  agentId         String    // donald-trump, cz, etc.
  createdAt       DateTime  @default(now())
  
  session         Session   @relation(fields: [sessionId], references: [id])
  messages        Message[]
  scores          Score[]
  
  @@index([sessionId, agentId])
  @@index([coralThreadId])
}

model Message {
  id              String    @id @default(cuid())
  threadId        String
  senderId        String    // Agent ID or "sbf"
  content         String    @db.Text
  timestamp       DateTime  @default(now())
  mentions        String[]  // Array of agent IDs
  isIntermediary  Boolean   @default(false)
  metadata        Json?     // For fallback messages and other metadata
  
  thread          Thread    @relation(fields: [threadId], references: [id])
  createdAt       DateTime  @default(now())
  
  @@index([threadId, timestamp])
  @@index([threadId, createdAt])
  @@index([senderId])
  @@index([threadId, senderId])
}

model Score {
  id              String    @id @default(cuid())
  userId          String
  sessionId       String
  threadId        String?
  delta           Float     // Decimal scores (e.g., 1.8, 2.3, -2.1)
  currentScore    Float     // Score after this delta
  reason          String    // "Payment to CZ: +10" or "Insulted agent: -15"
  category        String    // "payment", "negotiation", "milestone", "penalty"
  subcategory     String?   // "insult", "quality_message", "combo", "spam", etc.
  agentId         String?   // Which agent awarded/deducted points
  messageId       String?   // Which message triggered this score change
  timestamp       DateTime  @default(now())
  createdAt       DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id])
  session         Session   @relation(fields: [sessionId], references: [id])
  thread          Thread?   @relation(fields: [threadId], references: [id])
  
  @@index([userId, timestamp])
  @@index([userId, createdAt])
  @@index([sessionId, timestamp])
  @@index([sessionId])
  @@index([category])
  @@index([agentId])
}

model LeaderboardEntry {
  id              String    @id @default(cuid())
  userId          String
  weekId          String    // "2024-W45"
  finalScore      Float
  rank            Int
  prizeAmount     Decimal?  @db.Decimal(10, 4)
  createdAt       DateTime  @default(now())
  
  user            User      @relation(fields: [userId], references: [id])
  
  @@unique([userId, weekId])
  @@index([weekId, rank])
}

model Payment {
  id              String    @id @default(cuid())
  fromUserId      String?   // null for user payments
  fromWallet      String
  toAgent         String
  toWallet        String
  amount          Decimal   @db.Decimal(10, 4)
  currency        String    // "SOL" or "PARDON"
  signature       String    @unique
  serviceType     String    // "insider_info", etc.
  paymentId       String?   // x402 payment ID
  verified        Boolean   @default(false)
  verifiedAt      DateTime?
  createdAt       DateTime  @default(now())
  
  // x402 Facilitator Integration
  x402Registered  Boolean   @default(false)
  x402ScanUrl     String?   // e.g., "https://www.x402scan.com/tx/2ji2s2X..."
  x402ScanId      String?   // CDP facilitator's transaction ID
  x402RegisteredAt DateTime?
  x402Error       String?   // Store any registration errors for debugging
  
  // Payment Context
  isAgentToAgent  Boolean   @default(false)
  initiatedBy     String?   // User wallet if user initiated the agent-to-agent payment
  
  @@index([fromWallet, createdAt])
  @@index([toWallet, createdAt])
  @@index([signature])
  @@index([x402Registered])
}

model ServiceUsage {
  id              String    @id @default(cuid())
  userId          String
  sessionId       String
  weekId          String    // "2024-W45" format - for weekly resets
  serviceType     String    // e.g., "pardon_recommendation", "golf_game_invite"
  agentId         String    // Which agent provided the service
  usageCount      Int       @default(1)
  lastUsedAt      DateTime  @default(now())
  firstUsedAt     DateTime  @default(now())
  
  // Track score impact for diminishing returns calculation
  lastScoreBonus  Float?
  
  // Cooldown tracking
  messagesSinceUse Int      @default(0)
  pointsSinceUse   Float    @default(0)
  
  @@unique([userId, weekId, serviceType, agentId])
  @@index([userId, sessionId])
  @@index([weekId, serviceType])
  @@index([userId, weekId])
}

// Admin Panel Models

model AdminUser {
  id              String    @id @default(cuid())
  username        String    @unique
  passwordHash    String?   // null on first login - user sets password
  setupToken      String?   // one-time token for initial password setup
  createdAt       DateTime  @default(now())
  lastLoginAt     DateTime?
  isActive        Boolean   @default(true)
  
  // Account lockout fields
  failedLoginAttempts Int      @default(0)
  lockedUntil         DateTime?
  
  sessions        AdminSession[]
  auditLogs       AdminAuditLog[]
}

model AdminSession {
  id              String    @id @default(cuid())
  adminUserId     String
  token           String    @unique
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  ipAddress       String?
  userAgent       String?
  
  admin           AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([adminUserId])
}

model AdminAuditLog {
  id              String    @id @default(cuid())
  adminUserId     String
  action          String    // "view_user", "search_messages", "export_data"
  resource        String?   // userId, walletAddress, etc.
  details         Json?     // Additional context
  ipAddress       String?
  timestamp       DateTime  @default(now())
  
  admin           AdminUser @relation(fields: [adminUserId], references: [id])
  
  @@index([adminUserId, timestamp])
  @@index([action, timestamp])
}

model IntermediaryState {
  id          String   @id @default(cuid())
  agentId     String
  threadId    String
  targetAgent String
  purpose     String
  timestamp   DateTime @default(now())
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@unique([agentId, threadId])
  @@index([expiresAt])
  @@map("intermediary_states")
}

